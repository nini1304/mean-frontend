<div class="ag-page">
    <div class="ag-shell">
        <div class="hc-topbar">
            <button class="hc-back" type="button" (click)="volverMenu()">
                <span class="hc-back-ico">←</span>
                Volver a Pacientes
            </button>
        </div>
        <div class="ag-top">
            <div>
                
                <h1 >Citas y calendario</h1>
                
            </div>

            <div class="ag-actions">
                <span class="ag-pill" *ngIf="cargando">Cargando…</span>
                <span class="ag-pill err" *ngIf="!cargando && errorMsg">{{
                    errorMsg }}</span>
                <span class="ag-pill ok" *ngIf="toastMsg">{{ toastMsg }}</span>
            </div>

        </div>
        <div class="ag-filters">
            <label class="ag-label">Veterinario</label>

            <select class="ag-select"
                [disabled]="cargandoVets"
                [(ngModel)]="idVeterinario"
                (ngModelChange)="onVeterinarioChange($event)">
                <option value="" disabled>-- Selecciona --</option>
                <option *ngFor="let v of vets" [value]="v.id">
                    {{ v.usuario.nombre_completo }} · {{ v.especialidad }}
                </option>
            </select>

        </div>

        <div class="ag-card">
            <div class="ag-toolbar">
                <button class="ag-btn" type="button" (click)="abrirNuevaCita()"
                    [disabled]="!idVeterinario">
                    + Nueva cita
                </button>
            </div>

            <full-calendar [options]="calendarOptions"></full-calendar>
            <!-- Modal detalle de cita -->
            <div class="ag-modal-backdrop" *ngIf="showDetalle"
                (click)="cerrarDetalle()">
                <div class="ag-modal" (click)="$event.stopPropagation()">
                    <div class="ag-modal-top">
                        <div>
                            <div class="ag-modal-kicker">Detalle de cita</div>
                            <div class="ag-modal-title">
                                {{ citaSeleccionada?.tipo }} · {{
                                citaSeleccionada?.estado }}
                            </div>
                        </div>

                        <button class="ag-x" type="button"
                            (click)="cerrarDetalle()">×</button>
                    </div>

                    <div class="ag-modal-body" *ngIf="citaSeleccionada as c">
                        <div class="ag-row">
                            <span class="k">Motivo</span>
                            <span class="v">{{ c.notas || c.motivo || '-'
                                }}</span>
                        </div>

                        <div class="ag-row">
                            <span class="k">Inicio</span>
                            <span class="v">{{ formatDate(c.start) }}</span>
                        </div>

                        <div class="ag-row">
                            <span class="k">Fin</span>
                            <span class="v">{{ formatDate(c.end) }}</span>
                        </div>
                        <div class="ag-row">
                            <span class="k">Estado</span>
                            <span class="v">
                                <select class="ag-select"
                                    [ngModel]="estadoTmp"
                                    [ngModelOptions]="{ standalone: true }"
                                    (ngModelChange)="onCambiarEstado($event)">
                                    <option value="PENDIENTE">PENDIENTE</option>
                                    <option
                                        value="CONFIRMADA">CONFIRMADA</option>
                                    <option
                                        value="NO_ASISTIO">NO_ASISTIO</option>
                                    <option
                                        value="COMPLETADA">COMPLETADA</option>
                                </select>

                            </span>
                        </div>

                        <div class="ag-row">
                            <span class="k">Veterinario</span>
                            <span class="v">
                                {{ getVetNombre(c) }}
                                <span *ngIf="getVetEspecialidad(c)"> · {{
                                    getVetEspecialidad(c) }}</span>
                            </span>
                        </div>

                        <div class="ag-row">
                            <span class="k">Mascota</span>
                            <span class="v">
                                {{ getMascotaNombre(c) }}
                                <span *ngIf="getMascotaTipo(c)"> · {{
                                    getMascotaTipo(c) }}</span>
                            </span>
                        </div>

                        <div class="ag-row">
                            <span class="k">Dueño</span>
                            <span class="v">{{ c.dueno?.nombre_completo || '-'
                                }}</span>
                        </div>

                        <div class="ag-modal-actions">
                            <!-- ejemplo: cancelar -->
                            <button class="ag-btn danger" type="button"
                                (click)="cancelarDesdeModal(c._id)">
                                Cancelar cita
                            </button>
                            <button class="ag-btn" type="button"
                                (click)="cerrarDetalle()">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal crear cita -->
            <div class="ag-modal-backdrop" *ngIf="showCrear"
                (click)="cerrarCrear()">
                <div class="ag-modal" (click)="$event.stopPropagation()">
                    <div class="ag-modal-top">
                        <div>
                            <div class="ag-modal-kicker">Nueva cita</div>
                            <div class="ag-modal-title">Registrar en
                                agenda</div>
                        </div>
                        <button class="ag-x" type="button"
                            (click)="cerrarCrear()">×</button>
                    </div>

                    <div class="ag-modal-body">
                        <div class="ag-row">
                            <span class="k">Veterinario</span>
                            <span class="v">{{ getVetNombreFromSelected()
                                }}</span>
                        </div>

                        <div class="ag-row">
                            <span class="k">Mascota</span>
                            <span class="v">
                                <select class="ag-select"
                                    [(ngModel)]="form.id_mascota">
                                    <option value>-- Selecciona mascota
                                        --</option>
                                    <option *ngFor="let r of mascotas"
                                        [value]="r.mascota.id">
                                        {{ r.mascota.nombre }} ({{
                                        r.mascota.tipo_mascota }}) · Dueño: {{
                                        r.dueno.nombre_completo }}
                                    </option>
                                </select>
                            </span>
                        </div>

                        <div class="ag-row">
                            <span class="k">Tipo</span>
                            <span class="v">
                                <select class="ag-select"
                                    [(ngModel)]="form.tipo">
                                    <option value="CONSULTA">CONSULTA</option>
                                    <option value="VACUNA">VACUNA</option>
                                    <option value="CONTROL">CONTROL</option>
                                    <option value="CIRUGIA">CIRUGIA</option>
                                    <option value="OTRO">OTRO</option>
                                </select>
                            </span>
                        </div>

                        <div class="ag-row">
                            <span class="k">Inicio</span>
                            <span class="v">
                                <input class="ag-input" type="datetime-local"
                                    [(ngModel)]="form.startLocal">
                            </span>
                        </div>

                        <div class="ag-row">
                            <span class="k">Fin</span>
                            <span class="v">
                                <input class="ag-input" type="datetime-local"
                                    [(ngModel)]="form.endLocal">
                            </span>
                        </div>

                        <div class="ag-row">
                            <span class="k">Motivo</span>
                            <span class="v">
                                <input class="ag-input" type="text"
                                    [(ngModel)]="form.motivo"
                                    placeholder="Ej: Control post operatorio">
                            </span>
                        </div>

                        <div class="ag-modal-actions">
                            <button class="ag-btn danger" type="button"
                                (click)="guardarCita()">
                                Guardar
                            </button>
                            <button class="ag-btn" type="button"
                                (click)="cerrarCrear()">Cancelar</button>
                        </div>

                        <p class="ag-help" *ngIf="crearError">{{ crearError
                            }}</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
