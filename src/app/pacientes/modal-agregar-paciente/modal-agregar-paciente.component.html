<div class="vp-modal">
  <!-- backdrop -->
  <div class="vp-backdrop" (click)="cancelar()" aria-hidden="true"></div>

  <!-- dialog -->
  <div class="vp-dialog" role="dialog" aria-modal="true" aria-label="Registrar paciente">
    <!-- top bar -->
    <div class="vp-topbar">
      <div class="vp-title-wrap">
        <div class="vp-badge">üêæ</div>
        <div>
          <h2 class="vp-title">Registrar paciente</h2>
          <p class="vp-subtitle">Asocia un due√±o existente o crea uno nuevo</p>
        </div>
      </div>

      <button class="vp-close" type="button" (click)="cancelar()" aria-label="Cerrar">‚úï</button>
    </div>

    <!-- messages -->
    <div class="vp-messages" *ngIf="errorMsg || okMsg">
      <div class="vp-alert error" *ngIf="errorMsg">{{ errorMsg }}</div>
      <div class="vp-alert success" *ngIf="okMsg">{{ okMsg }}</div>
    </div>

    <form class="vp-form" [formGroup]="form" (ngSubmit)="submit()">
      <!-- mode selector -->
      <div class="vp-tabs">
        <button
          type="button"
          class="vp-tab"
          [class.active]="modo === 'EXISTENTE'"
          (click)="form.patchValue({ modo: 'EXISTENTE' })"
        >
          Due√±o existente
        </button>

        <button
          type="button"
          class="vp-tab"
          [class.active]="modo === 'NUEVO'"
          (click)="form.patchValue({ modo: 'NUEVO' })"
        >
          Due√±o nuevo
        </button>
        <div class="vp-tab-indicator" [class.right]="modo === 'NUEVO'"></div>
      </div>

      <!-- content grid -->
      <div class="vp-grid">
        <!-- LEFT: owner -->
        <section class="vp-card">
          <div class="vp-card-head">
            <h3 class="vp-card-title">
              <span class="vp-icon">üë§</span>
              Datos del due√±o
            </h3>
            <span class="vp-pill" *ngIf="modo === 'EXISTENTE'">Selecciona un cliente</span>
            <span class="vp-pill" *ngIf="modo === 'NUEVO'">Nuevo registro</span>
          </div>

          <!-- EXISTENTE -->
          <div *ngIf="modo === 'EXISTENTE'" class="vp-owner">
            <div class="vp-input-icon">
              <span class="vp-i">üîé</span>
              <input
                type="text"
                placeholder="Buscar por nombre, correo o celular..."
                [(ngModel)]="filtroCliente"
                [ngModelOptions]="{ standalone: true }"
              />
            </div>

            <div class="vp-list">
              <button
                type="button"
                class="vp-list-item"
                *ngFor="let c of clientesFiltrados()"
                (click)="seleccionarCliente(c)"
                [class.selected]="form.value.idUsuario === c._id"
              >
                <div class="vp-li-main">
                  <div class="vp-li-title">{{ c.nombre_completo }}</div>
                  <div class="vp-li-sub">{{ c.correo }} ¬∑ {{ c.numero_celular }}</div>
                </div>
                <div class="vp-li-check" *ngIf="form.value.idUsuario === c._id">‚úì</div>
              </button>

              <div class="vp-empty" *ngIf="clientesFiltrados().length === 0">
                No hay clientes para mostrar.
              </div>
            </div>

            <p class="vp-help error"
              *ngIf="form.get('idUsuario')?.touched && form.get('idUsuario')?.invalid">
              Debes seleccionar un due√±o.
            </p>
          </div>

          <!-- NUEVO -->
          <div *ngIf="modo === 'NUEVO'" formGroupName="dueno" class="vp-owner">
            <div class="vp-fields">
              <div class="vp-field">
                <label>Nombre completo</label>
                <input type="text" formControlName="nombre_completo" placeholder="Ej: Juan P√©rez" />
              </div>

              <div class="vp-field">
                <label>Correo</label>
                <input type="email" formControlName="correo" placeholder="correo@dominio.com" />
              </div>

              <div class="vp-field">
                <label>Celular</label>
                <input type="text" formControlName="numero_celular" placeholder="70000000" />
              </div>

              <div class="vp-field" [formGroup]="form">
                <label>Contrase√±a</label>

                <div class="vp-pwd">
                  <input
                    [type]="showPassword ? 'text' : 'password'"
                    formControlName="contrasena"
                    autocomplete="new-password"
                    placeholder="M√≠n. 8, may√∫s/min√∫s, n√∫mero y especial"
                  />
                  <button
                    type="button"
                    class="vp-eye"
                    (click)="showPassword = !showPassword"
                    [attr.aria-label]="showPassword ? 'Ocultar contrase√±a' : 'Mostrar contrase√±a'"
                  >
                    {{ showPassword ? 'üôà' : 'üëÅ' }}
                  </button>
                </div>

                <div class="vp-rules">
                  <div class="vp-rule" [class.ok]="passwordRuleState().len">8+ caracteres</div>
                  <div class="vp-rule" [class.ok]="passwordRuleState().upper">1 may√∫scula</div>
                  <div class="vp-rule" [class.ok]="passwordRuleState().lower">1 min√∫scula</div>
                  <div class="vp-rule" [class.ok]="passwordRuleState().num">1 n√∫mero</div>
                  <div class="vp-rule" [class.ok]="passwordRuleState().special">1 especial</div>
                </div>

                <p class="vp-help error"
                  *ngIf="form.get('contrasena')?.touched && form.get('contrasena')?.invalid">
                  La contrase√±a no cumple los requisitos.
                </p>
              </div>

              <div class="vp-field" [formGroup]="form">
                <label>Confirmar contrase√±a</label>

                <div class="vp-pwd">
                  <input
                    [type]="showPassword2 ? 'text' : 'password'"
                    formControlName="confirmar_contrasena"
                    autocomplete="new-password"
                    placeholder="Repita la contrase√±a"
                  />
                  <button
                    type="button"
                    class="vp-eye"
                    (click)="showPassword2 = !showPassword2"
                    [attr.aria-label]="showPassword2 ? 'Ocultar contrase√±a' : 'Mostrar contrase√±a'"
                  >
                    {{ showPassword2 ? 'üôà' : 'üëÅ' }}
                  </button>
                </div>

                <p class="vp-help error"
                  *ngIf="form.hasError('passwordsMismatch') && form.get('confirmar_contrasena')?.touched">
                  Las contrase√±as no coinciden.
                </p>
              </div>
            </div>
          </div>
        </section>

        <!-- RIGHT: pets -->
        <section class="vp-card">
          <div class="vp-card-head">
            <h3 class="vp-card-title">
              <span class="vp-icon">üê∂</span>
              Mascotas
            </h3>

            <div class="vp-qty">
              <span class="vp-qty-label">Cantidad</span>
              <input
                type="number"
                min="1"
                max="10"
                formControlName="cantidadMascotas"
                (change)="onCantidadMascotasChange()"
              />
              <span class="vp-qty-hint">m√°x. 10</span>
            </div>
          </div>

          <div class="vp-pets">
            <div
              class="vp-pet"
              *ngFor="let _ of mascotasFA.controls; let i = index; trackBy: trackByIndex"
              [formGroup]="mascotaGroupAt(i)"
            >
              <div class="vp-pet-head">
                <div class="vp-pet-title">
                  <span class="vp-pet-dot"></span>
                  Mascota {{ i + 1 }}
                </div>
              </div>

              <div class="vp-fields vp-fields-pet">
                <div class="vp-field">
                  <label>Nombre</label>
                  <input type="text" formControlName="nombre" placeholder="Ej: Rocky" />
                </div>

                <div class="vp-field">
                  <label>Tipo</label>
                  <select formControlName="tipo_mascota">
                    <option value="" disabled>Seleccione...</option>
                    <option *ngFor="let t of tiposMascota" [value]="t._id">
                      {{ t.tipo_mascota }}
                    </option>
                  </select>
                </div>

                <div class="vp-field">
                  <label>Edad</label>
                  <input type="text" formControlName="edad" placeholder="Ej: 4 a√±os / 6 meses" />
                  <p class="vp-help error"
                    *ngIf="mascotaGroupAt(i).get('edad')?.touched && mascotaGroupAt(i).get('edad')?.invalid">
                    Formato v√°lido: "4 a√±os" o "6 meses"
                  </p>
                </div>

                <div class="vp-field">
                  <label>Peso (kg)</label>
                  <input type="number" min="0" step="0.1" formControlName="peso" placeholder="Ej: 12.5" />
                </div>

                <div class="vp-field">
                  <label>Sexo</label>
                  <select formControlName="sexo">
                    <option value="MACHO">MACHO</option>
                    <option value="HEMBRA">HEMBRA</option>
                  </select>
                </div>

                <div class="vp-field">
                  <label>Raza</label>
                  <input type="text" formControlName="raza" placeholder="Ej: Mestizo" />
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- footer -->
      <div class="vp-footer">
        <!-- <button type="button" class="vp-btn ghost" (click)="cancelar()">Cancelar</button> -->
        <button type="submit" class="vp-btn primary" [disabled]="cargando">
          {{ cargando ? 'Guardando...' : 'Guardar' }}
        </button>
      </div>
    </form>
  </div>
</div>
